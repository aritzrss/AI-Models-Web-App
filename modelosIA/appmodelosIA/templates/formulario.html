{% extends "base.html" %}
{% load static %}

{% block title %}Modelos IA{% endblock %}

{% block content %}

<div style="margin-bottom: 20px; text-align: right;">
    <a href="{% url 'crear_modelo' %}" class="btn" style="background-color: #28a745; color: white;">
        + A√±adir Nuevo Modelo
    </a>
</div>

{% comment %} Formulario de Filtros {% endcomment %}
<form method="get" class="form-filters">
  
  <!-- 1. NUEVO: Filtro por Dataset -->
  <!-- Esto carga la lista de datasets desde la base de datos -->
  <div>
    <label>Dataset</label>
    <select name="dataset">
      <option value="">Todos</option>
      {% for ds in Datasets %}
        <option value="{{ ds.id }}" {% if f.dataset|add:"0" == ds.id %}selected{% endif %}>
            {{ ds.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- 2. NUEVO: Ordenar por (Ranking) -->
  <!-- Esto permite al usuario elegir el orden de visualizaci√≥n -->
  <div>
    <label>Ordenar por</label>
    <select name="orden">
      <option value="">Nombre (A-Z)</option>
      <option value="mejor_valorado" {% if f.orden == 'mejor_valorado' %}selected{% endif %}>‚≠ê Mejor valorados</option>
      <option value="peor_valorado" {% if f.orden == 'peor_valorado' %}selected{% endif %}>‚≠ê Peor valorados</option>
      <option value="mas_votado" {% if f.orden == 'mas_votado' %}selected{% endif %}>M√°s populares</option>
    </select>
  </div>

  <!-- Filtros Originales -->
  <div>
    <label>Tipo de tarea</label>
    <select name="tipo_tarea">
      <option value="">Todos</option>
      {% for val,label in TipoTarea %}
        <option value="{{ val }}" {% if f.tipo_tarea == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div>
    <label>Familia</label>
    <select name="familia">
      <option value="">Todas</option>
      {% for val,label in Familia %}
        <option value="{{ val }}" {% if f.familia == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div>
    <label>Modalidad</label>
    <select name="modalidad">
      <option value="">Todas</option>
      {% for val,label in Modalidad %}
        <option value="{{ val }}" {% if f.modalidad == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div>
    <label>Escalado</label>
    <select name="requiere_escalado">
      <option value="">Todos</option>
      <option value="si" {% if f.requiere_escalado == 'si' %}selected{% endif %}>S√≠</option>
      <option value="no" {% if f.requiere_escalado == 'no' %}selected{% endif %}>No</option>
    </select>
  </div>
  
  <div>
    <label>Usa Œ±</label>
    <select name="usa_alpha">
      <option value="">Todos</option>
      <option value="si" {% if f.usa_alpha == 'si' %}selected{% endif %}>S√≠</option>
      <option value="no" {% if f.usa_alpha == 'no' %}selected{% endif %}>No</option>
    </select>
  </div>
  
  <div>
    <label>Usa kernel</label>
    <select name="usa_kernel">
      <option value="">Todos</option>
      <option value="si" {% if f.usa_kernel == 'si' %}selected{% endif %}>S√≠</option>
      <option value="no" {% if f.usa_kernel == 'no' %}selected{% endif %}>No</option>
    </select>
  </div>
  
  <div>
    <label>A√±o desde</label>
    <input type="number" name="anio_desde" min="1901" max="2025" step="1" value="{{ f.anio_desde }}">
  </div>
  
  <div>
    <label>A√±o hasta</label>
    <input type="number" name="anio_hasta" min= 1901 max="2025" step="1" value="{{ f.anio_hasta }}">
  </div>
  
  <div>
    <button type="submit" class="btn">Filtrar</button>
    <a href="{% url 'modelo' %}" class="btn btn-light">Limpiar</a>
  </div>
</form>

<p class="default">{{ lista_modelos|length }} resultados encontrados</p>

{% comment %} Grid de tarjetas {% endcomment %}
{% if lista_modelos %}
  <div class="grid">
    {% for modelo in lista_modelos %}
      <div class="card">
        {% comment %} Contenido principal de cada modelo {% endcomment %}
        <div class="card-content">
          <a href="{% url 'modelo_detail' modelo_id=modelo.id %}">
            <img class="img-thumb" src="{{ modelo.imagen_dashboard.url }}" alt="{{ modelo.nombre }}">
            
            <h2>{{ modelo.nombre }}</h2>
            
            <!-- 3. NUEVO: Visualizaci√≥n de Estrellas en la tarjeta -->
            <div class="rating-preview" style="color: #f39c12; font-weight: bold; margin-bottom: 5px;">
                {% if modelo.rating_promedio > 0 %}
                    ‚òÖ {{ modelo.rating_promedio|floatformat:1 }} 
                    <span style="color: #888; font-weight: normal; font-size: 0.9em;">({{ modelo.cantidad_votos }})</span>
                {% else %}
                    <span style="color: #ccc; font-weight: normal; font-size: 0.9em;">Sin valoraci√≥n</span>
                {% endif %}
            </div>
          </a>
          
          <p>{{ modelo.descripcion|truncatechars:120 }}</p>
          
          <p class="tags">
            <!-- Mostramos tambi√©n el Dataset si lo tiene -->
            {% if modelo.dataset %}
                <span style="background-color: #eef; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">
                    üìÇ {{ modelo.dataset.nombre }}
                </span><br>
            {% endif %}
            <strong>Tipo:</strong> {{ modelo.get_tipo_tarea_display }} ¬∑
            <strong>Familia:</strong> {{ modelo.get_familia_display }}
          </p>
        </div>
        
        {% comment %} Bot√≥n para abrir cada modelo {% endcomment %}
        <a class="btn" href="{% url 'modelo_detail' modelo_id=modelo.id %}">Ver detalles</a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No hay modelos que coincidan con los filtros.</p>
{% endif %}

{% endblock %}