{% extends "base.html" %}
{% load static %}

{% block title %}Detalles de {{ modelo.nombre }}{% endblock %}

{% block header %}
  <h1>{{ modelo.nombre }}</h1>
  <p class="default">Informaci√≥n detallada y par√°metros del modelo.</p>
{% endblock %}

{% block content %}

{# Estilos espec√≠ficos para esta p√°gina #}
<style>
    /* Clases auxiliares para no ensuciar el HTML con style="" */
    .sidebar-section {
        background: #f8f9fa; 
        padding: 20px; 
        border-radius: 8px; 
        border: 1px solid #ddd;
        margin-top: 20px;
    }
    
    .rating-header {
        margin-bottom: 15px;
    }
    
    .rating-score {
        font-size: 2em; 
        color: #ffc107;
        margin-right: 5px;
    }
    
    .rating-value {
        font-size: 1.5em; 
        font-weight: bold;
    }
    
    .rating-subtext {
        margin: 0; 
        color: #888; 
        font-size: 0.9em;
    }

    .param-list {
        list-style-type: none; 
        padding: 0;
    }

    .param-item {
        background: #fff; /* Blanco para contrastar con el fondo gris de la sidebar */
        border: 1px solid #eee;
        margin-bottom: 5px; 
        padding: 10px; 
        border-radius: 4px; 
        display: flex; 
        justify-content: space-between;
        align-items: center;
    }

    .vote-controls {
        display: flex; 
        gap: 10px; 
        width: 100%;
    }
</style>

<div class="detail-layout">

  {% comment %} --- COLUMNA IZQUIERDA: VISUAL Y DESCRIPTIVA --- {% endcomment %}
  <div class="detail-main">
    {% if modelo.imagen_dashboard %}
      <img class="detail-image" src="{{ modelo.imagen_dashboard.url }}" alt="Ilustraci√≥n de {{ modelo.nombre }}">
    {% endif %}
    
    <h2 style="margin-top: 24px;">Descripci√≥n</h2>
    <p>{{ modelo.descripcion|linebreaks }}</p>
  </div>

  {% comment %} --- COLUMNA DERECHA: DATOS T√âCNICOS E INTERACCI√ìN --- {% endcomment %}
  <div class="detail-sidebar">
    
    <!-- 1. Ficha T√©cnica B√°sica -->
    <ul class="info-list">
      <li><strong>Tipo de tarea:</strong> {{ modelo.get_tipo_tarea_display }}</li>
      <li><strong>Familia:</strong> {{ modelo.get_familia_display }}</li>
      <li><strong>Modalidad:</strong> {{ modelo.get_modalidad_display }}</li>
      <li><strong>Requiere escalado:</strong> {{ modelo.requiere_escalado|yesno:"S√≠,No" }}</li>
      <li><strong>Usa Œ±:</strong> {{ modelo.usa_alpha|yesno:"S√≠,No" }}</li>
      <li><strong>Usa kernel:</strong> {{ modelo.usa_kernel|yesno:"S√≠,No" }}</li>
      {% if modelo.anio_inventado %}
        <li><strong>A√±o inventado:</strong> {{ modelo.anio_inventado }}</li>
      {% endif %}
    </ul>

    <!-- 2. Par√°metros T√©cnicos -->
    <div class="sidebar-section">
        <h3 style="margin-top:0;">Par√°metros T√©cnicos</h3>
        
        {% if modelo.parametros.all %}
            <ul class="param-list">
                {% for param in modelo.parametros.all %}
                    <li class="param-item">
                        <strong>{{ param.nombre }}</strong> 
                        <span style="font-family: monospace; color: #d63384;">{{ param.valor }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #666; font-style: italic;">No hay par√°metros definidos.</p>
        {% endif %}
    </div>

    <!-- 3. Caja de Valoraci√≥n (con AJAX) -->
    <!-- Este div act√∫a como contenedor para ser actualizado por AJAX -->
    <div id="valoracion-container" class="sidebar-section">
        {% include 'valoracion.html' %}
    </div>

  </div>

</div>

<div style="margin-top: 32px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 20px;">
  
  <a class="btn btn-light" href="{% url 'modelo' %}">‚Üê Volver al dashboard</a>

  <a href="{% url 'borrar_modelo' modelo.id %}" class="btn" style="background-color: #dc3545; color: white; border:none;">
    üóëÔ∏è Eliminar Modelo
  </a>

</div>

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Seleccionamos el contenedor. Escucharemos los eventos en √©l
    // porque el formulario de dentro ser√° reemplazado despu√©s de cada voto.
    const valoracionContainer = document.getElementById('valoracion-container');

    if (valoracionContainer) {
        valoracionContainer.addEventListener('submit', function(event) {
            
            // Nos aseguramos de que el evento viene del formulario de votaci√≥n
            if (event.target && event.target.id === 'form-votar') {
                
                // 1. Prevenimos el env√≠o normal que recarga toda la p√°gina
                event.preventDefault();
                
                const form = event.target;
                const button = form.querySelector('button[type="submit"]');

                // 2. Damos feedback visual al usuario mientras se procesa el voto
                button.disabled = true;
                button.innerHTML = '‚è≥';

                // 3. Hacemos la petici√≥n AJAX con Fetch API
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: new FormData(form) // FormData env√≠a los datos del form, incluido el CSRF token
                })
                .then(response => response.json()) // Esperamos una respuesta en formato JSON
                .then(data => {
                    // 4. Reemplazamos el contenido del contenedor con el nuevo HTML recibido
                    valoracionContainer.innerHTML = data.html;
                })
                .catch(error => {
                    console.error('Error al procesar el voto:', error);
                    // Si algo falla, restauramos el bot√≥n para que el usuario pueda reintentar
                    button.disabled = false;
                    button.innerHTML = 'Enviar';
                });
            }
        });
    }
});
</script>
{% endblock %}